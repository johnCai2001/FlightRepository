<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Dashboard - Phase 3-2</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
<!--Map CSS-->
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 999;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    main {
      height: calc(100vh - 49px);
      display: grid;
      grid-template-columns: 1fr 320px;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    aside {
      border-left: 1px solid #ddd;
      padding: 12px;
      background: #fff;
    }

    .muted {
      color: #666;
      font-size: 13px;
      line-height: 1.5;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .k {
      color: #666;
      font-size: 12px;
    }

    .v {
      font-weight: bold;
      font-size: 13px;
    }
  </style>	
  
  
  <!--航班列表CSS-->
<style>
	/* ===== 整體版面 ===== */
	.layout{
	  display:grid;
	  grid-template-columns: 320px 1fr 300px;
	  gap: 12px;
	  padding: 12px;
	}

	#map{
	  height: calc(100vh - 120px);
	  min-height: 600px;
	  border: 1px solid #ddd;
	  border-radius: 8px;
	}

	/* ===== Panel（保留給其他用） ===== */
	.panel{
	  border:1px solid #ddd;
	  border-radius:8px;
	  background:#fff;
	  padding:8px;
	  overflow:hidden;
	}

	/* ===== Flights 專用：input 等級外框 ===== */
	.flights-panel{
	  border:1px solid #ccc;
	  border-radius:6px;
	  background:#fff;
	  padding:6px;
	}

	/* Flights 標題 */
	.flights-panel h3{
	  margin: 0 0 6px;
	  font-size: 16px;
	}

	/* Search input（跟外框同等級） */
	#flightSearch{
	  width:100%;
	  box-sizing:border-box;
	  border:1px solid #ccc;
	  border-radius:6px;
	  font-size:13px;
	  padding:5px 8px;
	  margin-bottom:6px;
	}

	/* ===== FlightNumbers 外框（跟 input 一樣） ===== */
	.tableWrap{
	  border:1px solid #ccc;
	  border-radius:6px;
	  padding:0;
	  max-height: calc(100vh - 240px);
	  overflow:auto;
	}

	/* ===== 航班列表本體 ===== */
	.flightTable{
	  width:100%;
	  border-collapse:collapse;
	  font-size:12px;
	  line-height:1.2;
	}

	.flightTable th,
	.flightTable td{
	  padding:4px 6px;
	  border-bottom:1px solid #eee;
	  white-space:nowrap;
	}

	.flightTable th{
	  position:sticky;
	  top:0;
	  background:#fff;
	  font-weight:600;
	  z-index:1;
	}

	.flightTable tbody tr{
	  cursor:pointer;
	}

	.flightTable tbody tr:hover{
	  background:#f5f8ff;
	}

	.flightTable tbody tr.active{
	  background:#e3edff;
	  font-weight:600;
	}

	/* 小字 */
	.muted{
	  color:#666;
	  font-size:12px;
	}

  </style>
</head>



<body>
  <header>
    <h1>✈️ Flight Main Dashboard</h1>
    <div class="muted">Phase 3-2：後端 API → 地圖 marker</div>
  </header>
   
  
  <!--航班列表 -->
  <main class="layout">
    <section class="panel" id="flightPanel">
      <h3>Flights</h3>

      <input id="flightSearch" placeholder="Search flightNum" disabled />

      <div class="tableWrap">
        <table class="flightTable">
          <thead>
            <tr>
              <th>FlightNumbers</th>
            </tr>
          </thead>
          <tbody id="flightTbody">
            <!-- JS 動態塞 -->
          </tbody>
        </table>
      </div>
    </section>

    <section id="map"></section>

    <aside class="card" id="flightCard">
      <h3>Selected Flight</h3>
      <div id="flightInfo" class="muted">Click a marker on the map.</div>
    </aside>
  
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // 初始化地圖
    const map = L.map("map").setView([25.0777, 121.2328], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    // 串接後端 API
    const API_URL = "/api/flight";

    //去文件中去取得<div>中的flightinfo，預設值為(0))
    const flightInfoEl = document.getElementById("flightInfo");
    let selectedFlightNum = null;

    const markerMap = new Map();
	//動態表
	const animStateMap = new Map();
    let didFitBounds = false;

    // 建立飛機 icon
    function createPlaneIcon(heading) {
      return L.divIcon({
        className: "",
        html: `
          <div style="
            transform: rotate(${Number(heading) || 0}deg);
            width: 24px; height: 24px;
            display: grid; place-items: center;
            font-size: 18px;
          ">✈️</div>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    // 更新右側資訊卡
    function renderFlightCard(f) {
      if (!flightInfoEl) return;
      flightInfoEl.innerHTML = `
        <div class="row"><div class="k">Flight</div><div class="v">${f.flightNum}</div></div>
        <div class="row"><div class="k">Lat</div><div class="v">${Number(f.lat).toFixed(4)}</div></div>
        <div class="row"><div class="k">Lon</div><div class="v">${Number(f.lon).toFixed(4)}</div></div>
        <div class="row"><div class="k">Heading</div><div class="v">${f.heading}°</div></div>
        <div class="row"><div class="k">Altitude</div><div class="v">${f.altitude} ft</div></div>
        <div class="row"><div class="k">Speed</div><div class="v">${f.speed} kts</div></div>
      `;
    }

    const lastPosMap = new Map();
    const animMap = new Map();

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function lerpAngle(a, b, t) {
      let diff = ((b - a + 540) % 360) - 180;
      return (a + diff * t + 360) % 360;
    }

    function smoothMoveMarker(key, marker, toLat, toLon, toHeading, duration = 900) {
      const from = lastPosMap.get(key) || {
        lat: marker.getLatLng().lat,
        lon: marker.getLatLng().lng,
        heading: 0
      };

      if (animMap.has(key)) cancelAnimationFrame(animMap.get(key));

      const start = performance.now();

      function step(now) {
        const t = Math.min(1, (now - start) / duration);

        const lat = lerp(from.lat, toLat, t);
        const lon = lerp(from.lon, toLon, t);
        const heading = lerpAngle(from.heading, toHeading, t);

        marker.setLatLng([lat, lon]);
        marker.setIcon(createPlaneIcon(heading));

        if (t < 1) {
          const id = requestAnimationFrame(step);
          animMap.set(key, id);
        } else {
          animMap.delete(key);
          lastPosMap.set(key, { lat: toLat, lon: toLon, heading: toHeading });
        }
      }

      const id = requestAnimationFrame(step);
      animMap.set(key, id);
    }

    // ===== 載入 + 更新飛機 =====
    async function loadFlights() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const flights = Array.isArray(data) ? data : (data.flights ?? data.data ?? []);

        const seen = new Set();

        for (const f of flights) {
          const key = f.flightNum;
          if (!key) continue;

          const lat = Number(f.lat);
          const lon = Number(f.lon);
          const heading = Number(f.heading) || 0;
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

          seen.add(key);

          if (!markerMap.has(key)) {
            // CREATE
            const marker = L.marker([lat, lon], { icon: createPlaneIcon(heading) }).addTo(map);

            marker.bindTooltip(key, { permanent: true, direction: "top" });

            marker.on("click", () => {
              selectedFlightNum = key;
              renderFlightCard(f);
            });

            markerMap.set(key, marker);
            lastPosMap.set(key, { lat, lon, heading });
          } else {
            // UPDATE
            const marker = markerMap.get(key);
            smoothMoveMarker(key, marker, lat, lon, heading);
          }

          if (selectedFlightNum === key) renderFlightCard(f);
        }

        // DELETE
        for (const [key, marker] of markerMap.entries()) {
          if (!seen.has(key)) {
            if (animMap.has(key)) cancelAnimationFrame(animMap.get(key));
            animMap.delete(key);
            lastPosMap.delete(key);

            map.removeLayer(marker);
            markerMap.delete(key);
          }
        }

        // 第一次自動縮放
        if (!didFitBounds && markerMap.size > 0) {
          const group = L.featureGroup([...markerMap.values()]);
          map.fitBounds(group.getBounds().pad(0.3));
          didFitBounds = true;
        }
      } catch (e) {
        console.error("loadFlights error:", e);
      }
    }

	//3-5更新位置優化
	let isLoading = false;

	async function loadFlightsSafe() {
	  if (isLoading) return;  
	  isLoading = true;

	  try {
	    await loadFlights();  
	  } finally {
	    isLoading = false;
	  }
	}
	
	loadFlightsSafe();
	setInterval(loadFlightsSafe, 2000);
	
	</script>

  </script>
