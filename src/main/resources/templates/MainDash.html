<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Dashboard - Phase 3-2</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
<!--Map CSS-->
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 999;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    main {
      height: calc(100vh - 49px);
      display: grid;
      grid-template-columns: 1fr 320px;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    aside {
      border-left: 1px solid #ddd;
      padding: 12px;
      background: #fff;
    }

    .muted {
      color: #666;
      font-size: 13px;
      line-height: 1.5;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .k {
      color: #666;
      font-size: 12px;
    }

    .v {
      font-weight: bold;
      font-size: 13px;
    }
  </style>	
  
  
  <!--航班列表CSS-->
<style>

	.layout{
	  display:grid;
	  grid-template-columns: 320px 1fr 300px;
	  gap: 12px;
	  padding: 12px;
	}

	#map{
	  height: calc(100vh - 120px);
	  min-height: 600px;
	  border: 1px solid #ddd;
	  border-radius: 8px;
	}

	.panel{
	  border:1px solid #ddd;
	  border-radius:8px;
	  background:#fff;
	  padding:8px;
	  overflow:hidden;
	}

	.flights-panel{
	  border:1px solid #ccc;
	  border-radius:6px;
	  background:#fff;
	  padding:6px;
	}

	.flights-panel h3{
	  margin: 0 0 6px;
	  font-size: 16px;
	}

	#flightSearch{
	  width:100%;
	  box-sizing:border-box;
	  border:1px solid #ccc;
	  border-radius:6px;
	  font-size:13px;
	  padding:5px 8px;
	  margin-bottom:6px;
	}

	.tableWrap{
	  border:1px solid #ccc;
	  border-radius:6px;
	  padding:0;
	  max-height: calc(100vh - 240px);
	  overflow:auto;
	}

	/* ===== 航班列表本體 ===== */
	.flightTable{
	  width:100%;
	  border-collapse:collapse;
	  font-size:12px;
	  line-height:1.2;
	}

	.flightTable th,
	.flightTable td{
	  padding:4px 6px;
	  border-bottom:1px solid #eee;
	  white-space:nowrap;
	}

	.flightTable th{
	  position:sticky;
	  top:0;
	  background:#fff;
	  font-weight:600;
	  z-index:1;
	}

	.flightTable tbody tr{
	  cursor:pointer;
	}

	.flightTable tbody tr:hover{
	  background:#f5f8ff;
	}

	.flightTable tbody tr.active{
	  background:#e3edff;
	  font-weight:600;
	}
	.muted{
	  color:#666;
	  font-size:12px;
	}	

  </style>
</head>



<body>
  <header>
    <h1>✈️ Flight Main Dashboard</h1>
    <div class="muted">Phase 3-2：後端 API → 地圖 marker</div>
  </header>
   
  
  <!--航班列表 -->
  <main class="layout">
    <section class="panel" id="flightPanel">
      <h3>Flights</h3>
  <!--搜尋框-->
	  <input
	     id="flightSearch"
	     type="text"
	     placeholder="Search flightNumber"
	     autocomplete="off"
	     style="
	     "/>
	  <div id="flightList"></div>

	  <!--航班表-->	  
	  <div class="tableWrap">
	    <table class="flightTable">
			<thead>
	        <tr>
	          <th>Flight Number</th>
	        </tr>
	      </thead>
		  <tbody>
		    <tr th:each="f : ${flightNumbers}">
				<td>
				 <button type="button"
				              class="flightBtn"
				              th:attr="data-flightnum=${f}"
				              th:text="${f}">
				   </button>
				 </td>
		    </tr>
		  </tbody>
	    </table>
	  </div>	 		  
    </section>

    <section id="map"></section>

    <aside class="card" id="flightCard">
      <h3>Selected Flight</h3>
      <div id="flightInfo" class="muted">Click a marker on the map.</div>
    </aside>
  
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // 初始化地圖
    const map = L.map("map").setView([25.0777, 121.2328], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    // 串接後端 API
    const API_URL = "/api/flight";
	
	// ================================點航班按鈕============================================
	document.addEventListener("click", async (e) => {
	  const btn = e.target.closest(".flightBtn");
	  if (!btn) return;

	  const flightNum = btn.dataset.flightnum;
	  if (!flightNum) return;

	  selectedFlightNum = flightNum;

	  //拉最新 flights
	  const res = await fetch(API_URL);
	  const flights = await res.json();

	  // 2) 找到被點的那台
	  const f = flights.find(x => x.flightNum === flightNum);
	  if (!f) {
	    flightInfoEl.textContent = `找不到 ${flightNum}（可能剛好不在資料裡）`;
	    return;
	  }

	  renderSelectedFlight(f);

	  focusFlightOnMap(flightNum);
	});

	function renderSelectedFlight(f) {
	  flightInfoEl.innerHTML = `
	  <div class="row"><div class="k">Flight</div><div class="v">${f.flightNum}</div></div>
	        <div class="row"><div class="k">Lat</div><div class="v">${Number(f.lat).toFixed(4)}</div></div>
	        <div class="row"><div class="k">Lon</div><div class="v">${Number(f.lon).toFixed(4)}</div></div>
	        <div class="row"><div class="k">Heading</div><div class="v">${f.heading}°</div></div>
	        <div class="row"><div class="k">Altitude</div><div class="v">${f.altitude} ft</div></div>
	        <div class="row"><div class="k">Speed</div><div class="v">${f.speed} kts</div></div>
	  `;
	  }
   //==================================================================================
    //去文件中去取得<div>中的flightinfo，預設值為(0))
    const flightInfoEl = document.getElementById("flightInfo");
    let selectedFlightNum = null;

    const markerMap = new Map();
	const animStateMap = new Map();
    let didFitBounds = false;

    // =======================================建立飛機======================================
    function createPlaneIcon(heading) {
      return L.divIcon({
        className: "",
        html: `
          <div style="
            transform: rotate(${Number(heading) || 0}deg);
            width: 24px; height: 24px;
            display: grid; place-items: center;
            font-size: 18px;
          ">✈️</div>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    // =================================更新右側資訊卡=====================================
    function renderFlightCard(f) {
      if (!flightInfoEl) return;
      flightInfoEl.innerHTML = `
        <div class="row"><div class="k">Flight</div><div class="v">${f.flightNum}</div></div>
        <div class="row"><div class="k">Lat</div><div class="v">${Number(f.lat).toFixed(4)}</div></div>
        <div class="row"><div class="k">Lon</div><div class="v">${Number(f.lon).toFixed(4)}</div></div>
        <div class="row"><div class="k">Heading</div><div class="v">${f.heading}°</div></div>
        <div class="row"><div class="k">Altitude</div><div class="v">${f.altitude} ft</div></div>
        <div class="row"><div class="k">Speed</div><div class="v">${f.speed} kts</div></div>`;
    }
//=====================================飛機航向姿態控制======================================
    const lastPosMap = new Map();
    const animMap = new Map();

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function lerpAngle(a, b, t) {
      let diff = ((b - a + 540) % 360) - 180;
      return (a + diff * t + 360) % 360;
    }

    function smoothMoveMarker(key, marker, toLat, toLon, toHeading, duration = 900) {
      const from = lastPosMap.get(key) || {
        lat: marker.getLatLng().lat,
        lon: marker.getLatLng().lng,
        heading: 0
      };

      if (animMap.has(key)) cancelAnimationFrame(animMap.get(key));

      const start = performance.now();

      function step(now) {
        const t = Math.min(1, (now - start) / duration);

        const lat = lerp(from.lat, toLat, t);
        const lon = lerp(from.lon, toLon, t);
        const heading = lerpAngle(from.heading, toHeading, t);

        marker.setLatLng([lat, lon]);
        marker.setIcon(createPlaneIcon(heading));

        if (t < 1) {
          const id = requestAnimationFrame(step);
          animMap.set(key, id);
        } else {
          animMap.delete(key);
          lastPosMap.set(key, { lat: toLat, lon: toLon, heading: toHeading });
        }
      }

      const id = requestAnimationFrame(step);
      animMap.set(key, id);
    }

    // ============================ 載入 + 更新飛機====================================
    async function loadFlights() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const flights = Array.isArray(data) ? data : (data.flights ?? data.data ?? []);

        const seen = new Set();

        for (const f of flights) {
          const key = f.flightNum;
          if (!key) continue;

          const lat = Number(f.lat);
          const lon = Number(f.lon);
          const heading = Number(f.heading) || 0;
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

          seen.add(key);

          if (!markerMap.has(key)) {
            // CREATE
            const marker = L.marker([lat, lon], { icon: createPlaneIcon(heading) }).addTo(map);

            marker.bindTooltip(key, { permanent: true, direction: "top" });

            marker.on("click", () => {
              selectedFlightNum = key;
              renderFlightCard(f);   
            });

            markerMap.set(key, marker);
            lastPosMap.set(key, { lat, lon, heading });
          } else {
            // UPDATE
            const marker = markerMap.get(key);
            smoothMoveMarker(key, marker, lat, lon, heading);
          }

          if (selectedFlightNum === key) renderFlightCard(f);
        }
		allFlights = flights;
		applySearch();

        // DELETE
        for (const [key, marker] of markerMap.entries()) {
          if (!seen.has(key)) {
            if (animMap.has(key)) cancelAnimationFrame(animMap.get(key));
            animMap.delete(key);
            lastPosMap.delete(key);

            map.removeLayer(marker);
            markerMap.delete(key);
          }
        }
        if (!didFitBounds && markerMap.size > 0) {
          const group = L.featureGroup([...markerMap.values()]);
          map.fitBounds(group.getBounds().pad(0.3));
          didFitBounds = true;
        }
      } catch (e) {
        console.error("loadFlights error:", e);
      }
    }
	
	//=======================================搜尋航班===========================================
	let allFlights = []; 

		const flightSearchEl = document.getElementById("flightSearch");
		const flightListEl = document.getElementById("flightList");
		
		function renderFlightList(list) {
		  if (!flightListEl) return;

		  flightListEl.innerHTML = "";

		  if (list.length === 0) {
		    flightListEl.innerHTML = `<div style="color:#888;">No flights</div>`;
		    return;
		  }

		  for (const f of list) {
		    const btn = document.createElement("button");
		    btn.type = "button";
		    btn.textContent = f.flightNum;

		    // 點擊航班
		    btn.addEventListener("click", () => {
		      selectedFlightNum = f.flightNum;

		      if (Number.isFinite(f.lat) && Number.isFinite(f.lon)) {
		        map.setView([f.lat, f.lon], Math.max(map.getZoom(), 11));
		      }
		    });

		    flightListEl.appendChild(btn);
		  }
		}

		// 套用搜尋條件
		function applySearch() {
		  const kw = (flightSearchEl?.value || "").trim().toUpperCase();

		  const filtered = allFlights.filter(f => {
		    const fn = String(f.flightNum|| "").toUpperCase();
		    if (!kw) return true;
		    return fn.includes(kw);
		  });

		  renderFlightList(filtered);
		}

		// 綁定搜尋事件
		if (flightSearchEl) {
		  flightSearchEl.addEventListener("input", applySearch);
		}
		
	//================================更新位置優化=========================================
	let isLoading = false;

	async function loadFlightsSafe() {
	  if (isLoading) return;  
	  isLoading = true;

	  try {
	    await loadFlights();  
	  } finally {
	    isLoading = false;
	  }
	}
	
	loadFlightsSafe();
	setInterval(loadFlightsSafe, 2000);
	
	//====================================搜尋航班===========================================
	
	</script>

  </script>
