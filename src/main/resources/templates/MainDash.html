<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Dashboard - Phase 3-2</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 999;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    main {
      height: calc(100vh - 49px);
      display: grid;
      grid-template-columns: 1fr 320px;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    aside {
      border-left: 1px solid #ddd;
      padding: 12px;
      background: #fff;
    }

    .muted {
      color: #666;
      font-size: 13px;
      line-height: 1.5;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .k {
      color: #666;
      font-size: 12px;
    }

    .v {
      font-weight: bold;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <header>
    <h1>✈️ Flight Main Dashboard</h1>
    <div class="muted">Phase 3-2：後端 API → 地圖 marker</div>
  </header>

  <main>
    <!-- 地圖 -->
    <div id="map"></div>

    <!-- 右側資訊卡 -->
    <aside>
      <h3>Selected Flight</h3>
      <div id="flightInfo" class="muted">
        Click a plane marker on the map.
      </div>
    </aside>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // 初始化地圖
    const map = L.map("map").setView([25.0777, 121.2328], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    // 串接後端 API
    const API_URL = "/api/flight";

    //去文件中去取得<div>中的flightinfo，預設值為(0))
    const flightInfoEl = document.getElementById("flightInfo");
    let selectedFlightNum = null;

    const markerMap = new Map();
    let didFitBounds = false;

    // 建立飛機 icon
    function createPlaneIcon(heading) {
      return L.divIcon({
        className: "",
        html: `
          <div style="
            transform: rotate(${Number(heading) || 0}deg);
            width: 24px; height: 24px;
            display: grid; place-items: center;
            font-size: 18px;
          ">✈️</div>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    // 更新右側資訊卡
    function renderFlightCard(f) {
      if (!flightInfoEl) return;
      flightInfoEl.innerHTML = `
        <div class="row"><div class="k">Flight</div><div class="v">${f.flightNum}</div></div>
        <div class="row"><div class="k">Lat</div><div class="v">${Number(f.lat).toFixed(4)}</div></div>
        <div class="row"><div class="k">Lon</div><div class="v">${Number(f.lon).toFixed(4)}</div></div>
        <div class="row"><div class="k">Heading</div><div class="v">${f.heading}°</div></div>
        <div class="row"><div class="k">Altitude</div><div class="v">${f.altitude} ft</div></div>
        <div class="row"><div class="k">Speed</div><div class="v">${f.speed} kts</div></div>
      `;
    }

    // ===== 3-5=====
    const lastPosMap = new Map();
    const animMap = new Map();

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function lerpAngle(a, b, t) {
      let diff = ((b - a + 540) % 360) - 180;
      return (a + diff * t + 360) % 360;
    }

    function smoothMoveMarker(key, marker, toLat, toLon, toHeading, duration = 900) {
      const from = lastPosMap.get(key) || {
        lat: marker.getLatLng().lat,
        lon: marker.getLatLng().lng,
        heading: 0
      };

      if (animMap.has(key)) cancelAnimationFrame(animMap.get(key));

      const start = performance.now();

      function step(now) {
        const t = Math.min(1, (now - start) / duration);

        const lat = lerp(from.lat, toLat, t);
        const lon = lerp(from.lon, toLon, t);
        const heading = lerpAngle(from.heading, toHeading, t);

        marker.setLatLng([lat, lon]);
        marker.setIcon(createPlaneIcon(heading));

        if (t < 1) {
          const id = requestAnimationFrame(step);
          animMap.set(key, id);
        } else {
          animMap.delete(key);
          lastPosMap.set(key, { lat: toLat, lon: toLon, heading: toHeading });
        }
      }

      const id = requestAnimationFrame(step);
      animMap.set(key, id);
    }

    // ===== 載入 + 更新飛機 =====
    async function loadFlights() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const flights = Array.isArray(data) ? data : (data.flights ?? data.data ?? []);

        const seen = new Set();

        for (const f of flights) {
          const key = f.flightNum;
          if (!key) continue;

          const lat = Number(f.lat);
          const lon = Number(f.lon);
          const heading = Number(f.heading) || 0;
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

          seen.add(key);

          if (!markerMap.has(key)) {
            // CREATE
            const marker = L.marker([lat, lon], { icon: createPlaneIcon(heading) }).addTo(map);

            marker.bindTooltip(key, { permanent: true, direction: "top" });

            marker.on("click", () => {
              selectedFlightNum = key;
              renderFlightCard(f);
            });

            markerMap.set(key, marker);
            lastPosMap.set(key, { lat, lon, heading });
          } else {
            // UPDATE
            const marker = markerMap.get(key);
            smoothMoveMarker(key, marker, lat, lon, heading);
          }

          if (selectedFlightNum === key) renderFlightCard(f);
        }

        // DELETE
        for (const [key, marker] of markerMap.entries()) {
          if (!seen.has(key)) {
            if (animMap.has(key)) cancelAnimationFrame(animMap.get(key));
            animMap.delete(key);
            lastPosMap.delete(key);

            map.removeLayer(marker);
            markerMap.delete(key);
          }
        }

        // 第一次自動縮放
        if (!didFitBounds && markerMap.size > 0) {
          const group = L.featureGroup([...markerMap.values()]);
          map.fitBounds(group.getBounds().pad(0.3));
          didFitBounds = true;
        }
      } catch (e) {
        console.error("loadFlights error:", e);
      }
    }

    // 先跑一次 + 之後每 1秒更新
    loadFlights();
    setInterval(loadFlights, 1000);
  </script>
