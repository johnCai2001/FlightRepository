<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Dashboard - Phase 3-2</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 999;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    main {
      height: calc(100vh - 49px);
      display: grid;
      grid-template-columns: 1fr 320px;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    aside {
      border-left: 1px solid #ddd;
      padding: 12px;
      background: #fff;
    }

    .muted {
      color: #666;
      font-size: 13px;
      line-height: 1.5;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .k {
      color: #666;
      font-size: 12px;
    }

    .v {
      font-weight: bold;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <header>
    <h1>✈️ Flight Main Dashboard</h1>
    <div class="muted">Phase 3-2：後端 API → 地圖 marker</div>
  </header>

  <main>
    <!-- 地圖 -->
    <div id="map"></div>

    <!-- 右側資訊卡 -->
    <aside>
      <h3>Selected Flight</h3>
      <div id="flightInfo" class="muted">
        Click a plane marker on the map.
      </div>
    </aside>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>

    //初始化地圖
    const map = L.map("map").setView([25.0777, 121.2328], 10);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    //後端 API 路徑
    const API_URL = "/api/flight";

    //UI元件
    const flightInfoEl = document.getElementById("flightInfo");
    let selectedFlightNum = null;

	// 前端的 API 資料狀態管理

	const markerMap = new Map();

	// 從後端拿最新世界狀態
	//async非同步處理函數
	  async function loadFlights() {
	  const res = await fetch(API_URL);
	  const flights = await res.json();

	  //用來記錄API有出現哪些 flights
	  const seen = new Set();

	  
	  
	  for (const f of flights) {
	    seen.add(f.flightNum);

	    // CREATE：第一次看到這架飛機
	    if (!markerMap.has(f.flightNum)) {
			 const marker = L.marker(
	        [f.lat, f.lon],
	        { icon: createPlaneIcon(f.heading) }
	      ).addTo(map);

	      marker.on("click", () => {
	        selectedFlightNum = f.flightNum;
	        renderFlightCard(f);
	      });

	      markerMap.set(f.flightNum, marker);
	    }
	    // UPDATE：同一架飛機，只更新狀態
	    else {
		  const marker = markerMap.get(f.flightNum);
	      marker.setLatLng([f.lat, f.lon]);
	      marker.setIcon(createPlaneIcon(f.heading));
	    }

	    // 若目前被選中，資訊卡同步更新
	    if (selectedFlightNum === f.flightNum) {
	      renderFlightCard(f);
	    }
	  }

	  // DELETE：這次 API 沒回來的飛機 → 移除
	  for (const [flightNum, marker] of markerMap.entries()) {
	    if (!seen.has(flightNum)) {
	      map.removeLayer(marker);
	      markerMap.delete(flightNum);
	    }
	  }
	}

    //飛機 icon
    function createPlaneIcon(heading) {
      return L.divIcon({
        className: "",
        html: `
          <div style="
            transform: rotate(${heading}deg);
            width: 24px;
            height: 24px;
            display: grid;
            place-items: center;
            font-size: 18px;
          ">✈️</div>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    //更新右側資訊卡
    function renderFlightCard(f) {
      if (!flightInfoEl) return;

      flightInfoEl.innerHTML = `
        <div class="row"><div class="k">Flight</div><div class="v">${f.flightNum}</div></div>
        <div class="row"><div class="k">Lat</div><div class="v">${Number(f.lat).toFixed(4)}</div></div>
        <div class="row"><div class="k">Lon</div><div class="v">${Number(f.lon).toFixed(4)}</div></div>
        <div class="row"><div class="k">Heading</div><div class="v">${f.heading}°</div></div>
        <div class="row"><div class="k">Altitude</div><div class="v">${f.altitude} ft</div></div>
        <div class="row"><div class="k">Speed</div><div class="v">${f.speed} kts</div></div>
      `;
    }

    //從後端載入資料並更新地圖
    async function loadFlights() {
      try {
        console.log(" fetch flights");

        const res = await fetch(API_URL);
        console.log(" status:", res.status);

        if (!res.ok) return;

        const flights = await res.json();
        console.log("flights:", flights);

        const seen = new Set();

        for (const f of flights) {
          seen.add(f.flightNum);

          //新飛機
          if (!markerMap.has(f.flightNum)) {
            const marker = L.marker(
              [Number(f.lat), Number(f.lon)],
              { icon: createPlaneIcon(f.heading) }
            ).addTo(map);

            marker.bindTooltip(f.flightNum, {
              permanent: true,
              direction: "top"
            });

            marker.on("click", () => {
              selectedFlightNum = f.flightNum;
              renderFlightCard(f);
            });

            markerMap.set(f.flightNum, marker);
          }
          
		  
		  
          else {
            const marker = markerMap.get(f.flightNum);
            marker.setLatLng([Number(f.lat), Number(f.lon)]);
            marker.setIcon(createPlaneIcon(f.heading));
          }

          if (selectedFlightNum === f.flightNum) {
            renderFlightCard(f);
          }
        }

        //移除是野外的飛機
        for (const [flightNum, marker] of markerMap.entries()) {
          if (!seen.has(flightNum)) {
            map.removeLayer(marker);
            markerMap.delete(flightNum);
          }
        }

        //自動縮放到所有飛機
        if (markerMap.size > 0) {
          const group = L.featureGroup([...markerMap.values()]);
          map.fitBounds(group.getBounds().pad(0.3));
        }

      } catch (e) {
        console.error(" loadFlights error:", e);
      }
    }
	
    loadFlights();
    setInterval(loadFlights, 3000);
  </script>
</body>
</html>
